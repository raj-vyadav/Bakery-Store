{% extends 'base.html' %}

{% block title %}Bakery Menu{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h1>Our Bakery Menu üßÅ</h1>
    <p class="lead">Freshly baked goods, made with love.</p>
</div>
<div id="products-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const productsContainer = document.getElementById('products-container');

        // Fetch and display products
        fetch('/api/products/')
            .then(response => response.json())
            .then(products => {
                products.forEach(product => {
                    const productCard = `
                        <div class="col">
                            <div class="card h-100">
                                <img src="${product.p_img || '/media/placeholder.png'}" class="card-img-top" alt="${product.name}" style="height: 200px; object-fit: cover;">
                                <div class="card-body d-flex flex-column text-light">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text flex-grow-1">${product.description}</p>
                                    <p class="card-text fs-5 fw-bold">$${product.price}</p>
                                    <button class="btn btn-primary mt-auto add-to-cart-btn" data-product-id="${product.id}">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    productsContainer.insertAdjacentHTML('beforeend', productCard);
                });
            })
            .catch(error => console.error('Error fetching products:', error));

        // Add to cart event listener
        productsContainer.addEventListener('click', function(event) {
            if (event.target && event.target.matches('.add-to-cart-btn, .add-to-cart-btn *')) {
                const button = event.target.closest('.add-to-cart-btn');
                const productId = button.dataset.productId;

                fetch('/api/cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ product_id: productId, quantity: 1 })
                })
                .then(response => {
                    if (response.status === 403) {
                        window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Added to cart:', data);
                    alert('Item added to cart!');
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    alert('Failed to add item to cart. Please try again.');
                });
            }
        });
    });
</script>
{% endblock %}